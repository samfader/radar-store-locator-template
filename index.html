<!DOCTYPE html>
<html>

<head>
    <title>Radar Web Store Locator Template</title>
    <!-- radar sdk -->
    <script src="https://js.radar.com/v3/radar.min.js"></script>

    <!-- basemaps via MapLibre -->
    <script src='https://unpkg.com/maplibre-gl@2.1.1/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@2.1.1/dist/maplibre-gl.css' rel='stylesheet' />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <!-- Local CSS -->
    <link rel="stylesheet" type="text/css" href="styles.css" />

    <!-- jQuery for loading bar -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>

<body>
    <div class="" container-fluid">
        <div class="row row-no-gutters">
            <div id='sidebar' class="col-md-12">
                <div class="heading">
                    <h1>McRadar's Locations</h1>
                </div>
                <div id="listings" class="listings">
                    <div class="storeLocatorContent">
                        <div class="storeLocatorSearchContainer">
                            <div class="form-group has-feedback col-lg-2">
                                <input type="search" list="autocompleteResults" class="form-control"
                                    id="addressSearchInput" placeholder="Find a store" />
                                <span class="glyphicon glyphicon-search form-control-feedback"></span>
                            </div>
                            <button type="button" id="addressSearchBtn" class="btn btn-primary">Search</button>
                        </div>
                        <div id="searchResultsContainer" class=".col-md-1">
                            <table id="resultsTable" class="table">

                            </table>
                        </div>
                        <div class="storeLocatorContainerDivider">
                            <hr class="separator">
                            <!-- TO DO: center the logo -->
                            <div id="logo">
                                <img src="logo.png">
                            </div>
                            <div class="table-responsive">
                                <table id="storeListings" class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">Store Name</th>
                                            <th scope="col">Hours</th>
                                            <th scope="col">Wifi?</th>
                                            <th scope="col">Distance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id='map' class="col-md-4"></div>
                    <div id="cover-spin"></div>
                </div>
            </div>
        </div>
        <script>
            // Tags to be used for geofence search. Only geofences (stores) with the tags listed here will show up on the map.
            // String, comma separated if using multiple values (i.e. var tag = "cafe,restaurant" or var tag ="mcradars")
            var tags = "mcradars"

            const ENABLE_AUTOCOMPLETE = true;
            const RADAR_TOKEN = "prj_test_pk_34485c992b0a89951fea67ae458c40f26711b944"

            // meters from search point to include
            const RADAR_SEARCH_RADIUS = 10000

            // markers saved here
            var currentMarkers = [];

            // Initialize Radar
            Radar.initialize(RADAR_TOKEN);

            var loadingSpinner = document.getElementById("cover-spin");
            var logo = document.getElementById("logo");

            // store results setup
            var table = document.getElementById('storeListings');
            var footer = table.createTFoot();
            var tableRows = table.getElementsByTagName('tr');
            var rowCount = tableRows.length;

            loadingSpinner.style.display = "block";

            // Request user's location
            Radar.trackOnce(function (err, result) {
                if (!err) {
                    loadingSpinner.style.display = "none";
                    const location = result.location;
                    centerMap(location.latitude, location.longitude);
                    searchUsingLocation(location);
                }
                else {
                    loadingSpinner.style.display = "none";
                    alert("Couldn't get location. Please use Search function.");
                }
            });

            // Set up search results table
            const resultsTable = document.getElementById("resultsTable");
            document.getElementById("addressSearchInput").oninput = debounce(handleAutocomplete);

            document.getElementById("addressSearchBtn").onclick = searchUsingInput;

            // Initialize the map - https://maplibre.org/
            var map = new maplibregl.Map({
                container: 'map',
                style: 'https://api.maptiler.com/maps/streets/style.json?key=JlT0uJuoZfMPXCXMCgQ5',
                center: [-74.5, 40], // starting position [lng, lat]
                minZoom: 9,
                zoom: 3 // starting zoom
            });

            // Listen for a move end -- i.e. when the user stops panning or zooming on the map
            // Get the location when the move stops and then perform a search to update the markers
            map.on('moveend', function () {
                console.log('A moveend event occurred.');
                var { lng, lat } = map.getCenter();
                var location = {
                    longitude: lng,
                    latitude: lat
                }
                searchUsingLocation(location);
            });

            // remove markers from the map
            function clearMarkers() {
                if (currentMarkers !== null) {
                    for (var i = currentMarkers.length - 1; i >= 0; i--) {
                        currentMarkers[i].remove();
                    }
                }
            }

            // Add markers to the map based on coordinates
            function addMarker(coordinates, name, metadata) {
                var lat = coordinates[1];
                var lon = coordinates[0]

                // create the popup
                var popup = new maplibregl.Popup({ offset: 25 }).setHTML(
                    '<h4>Store name</h4>' + name +
                    '<h4>Hours</h4>' + metadata["Hours"] +
                    '<h4>Wifi?</h4>' + metadata["Wifi"]
                );

                // create DOM element for the marker
                var el = document.createElement('div');
                el.id = 'marker';
                var marker = new maplibregl.Marker()
                    .setLngLat([lon, lat])
                    .setPopup(popup)
                    .addTo(map)

                currentMarkers.push(marker);
            }

            function centerMap(lat, lon) {
                map.jumpTo({
                    center: [lon, lat],
                    zoom: 11.5
                });
            }

            // Use Radar search geofences API (https://radar.com/documentation/api#search-geofences)
            // to show nearby locations on the map
            function searchUsingLocation(location) {
                Radar.searchGeofences({
                    "near": location,
                    "radius": RADAR_SEARCH_RADIUS,
                    "tags": [tags],
                    "limit": 10
                }, function (err, result) {
                    if (!err) {
                        showNearbyLocations(result, location)
                    }
                })
            }

            function searchUsingInput() {
                const searchValue = document.getElementById("addressSearchInput").value;

                // Call Radar geocoding API (https://radar.com/documentation/api#geocoding) to 
                //translate user's input into coordinates.
                Radar.geocode({
                    "query": searchValue
                }, function (err, result) {
                    if (!err && result["addresses"].length > 0) {

                        const location = result["addresses"][0];

                        // Center the map and search geofences around the geocoded point
                        centerMap(location.latitude, location.longitude);
                        Radar.searchGeofences({
                            "near": location,
                            "radius": 10000,
                            "tags": [tags],
                            "limit": 10
                        }, function (err, result) {

                            if (!err) {
                                showNearbyLocations(result, location)
                            }
                        });

                    }
                });
            }

            // Responsible for adding map markers and updating the sidebar
            function showNearbyLocations(result, userLocation) {
                //Present the user with the nearby locations
                var geofences = result.geofences;
                if (geofences.length > 0) {
                    logo.style.display = "none";
                    for (var i = 0; i < geofences.length; i++) {
                        var coordinates = geofences[i]["geometryCenter"]["coordinates"];
                        addMarker(coordinates, geofences[i]["description"], geofences[i]["metadata"], location);
                    }
                    addStoresToSidebar(true, geofences, userLocation);
                } else {
                    logo.style.display = "block";
                    addStoresToSidebar(false, geofences, userLocation);
                }
            }


            // add store info to sidebar
            function addStoresToSidebar(show, geofences, userLocation) {
                if (show) {
                    clearSidebar();
                    geofences.forEach((geofence, index) => {
                        var rowFooter = footer.insertRow(index);
                        var geofenceCoords = { "longitude": geofence.geometryCenter.coordinates[0], "latitude": geofence.geometryCenter.coordinates[1] };

                        // TODO - update to Matrix API
                        // Use Radar Matrix API to get distances from origin point to markers on the map
                        Radar.getDistance({
                            origin: {
                                latitude: userLocation.latitude,
                                longitude: userLocation.longitude
                            },
                            destination: {
                                latitude: geofence.geometryCenter.coordinates[1],
                                longitude: geofence.geometryCenter.coordinates[0]
                            },
                            modes: [
                                'foot',
                                'car'
                            ],
                            units: 'imperial'
                        }, function (err, result) {
                            if (!err) {
                                rowFooter.insertCell(0).innerHTML = geofence["description"]
                                rowFooter.insertCell(1).innerHTML = geofence["metadata"]["Hours"]
                                rowFooter.insertCell(2).innerHTML = geofence["metadata"]["Wifi"]
                                rowFooter.insertCell(3).innerHTML = result["routes"]["geodesic"]["distance"]["text"];
                                // return result.routes.car.distance.text;
                            }
                        });
                    });
                } else {
                    // If no stores, clear the sidebar and clear markers
                    clearSidebar();
                    clearMarkers();
                }
            }

            // clear sidebaqr
            function clearSidebar() {
                console.log('clearing sidebidar...row count is ' + table.rows.length);
                while (table.rows.length > 0) {
                    table.deleteRow(0);
                }
            }

            // debounce function used for handling autocomplete input
            function debounce(func) {
                const delay = 100;
                let debounceTimer;
                return function (...args) {
                    const context = this;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                }
            }

            // when autocomplete-input value changes
            function handleAutocomplete() {
                const userInput = this.value;
                if (userInput.length = 0) {
                    deleteTableRows();
                    return;
                }

                const searchValue = document.getElementById("addressSearchInput").value;
                // Call Radar autocomplete API (https://radar.com/documentation/api#autocomplete) 
                // to translate user's input into coordinates.
                Radar.autocomplete({
                    "query": searchValue,
                    "limit": 4
                }, function (err, result) {
                    if (!err && result["addresses"].length > 0) {
                        const location = result["addresses"][0];
                        deleteTableRows();
                        const addresses = result.addresses;

                        // gather addresses to present to user
                        for (i = addresses.length - 1; i >= 0; i--) {
                            var address = addresses[i].formattedAddress;
                            var row = resultsTable.insertRow(0);

                            var cell = row.insertCell(0);
                            cell.innerHTML = address;
                            cell.onclick = function () { setSearchInputWithValue(this) };
                        }
                    };
                });
            }

            function setSearchInputWithValue(cell) {
                document.getElementById("addressSearchInput").value = cell.innerHTML;
                deleteTableRows();
            }

            //Autocomplete results are stored in an HTML table
            function deleteTableRows() {
                while (table.rows.length > 0) {
                    table.deleteRow(0);
                }
                while (resultsTable.rows.length > 0) {
                    resultsTable.deleteRow(0);
                }
            }
        </script>
</body>